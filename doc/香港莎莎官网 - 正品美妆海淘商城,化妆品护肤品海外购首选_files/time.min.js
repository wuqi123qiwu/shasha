
(function(){sindex=this.sindex=[];selftimeCount=this.selftimeCount={that:this,init:function(endtime,dTime,dom,el,index){var NowTime=new Date();var diff=endtime-NowTime.getTime()-dTime;if(diff<=0)diff=0;var secondDiff=Math.round(diff/1000)%60;var minuteDiff=Math.floor((diff-secondDiff)/60000)%60;var hourDiff=Math.floor((diff-secondDiff-minuteDiff*60)/3600000)%24;var dayDiff=Math.floor((diff-secondDiff-minuteDiff*60-hourDiff*3600)/86400000);var timeDiff=[dayDiff,hourDiff,minuteDiff,parseInt(secondDiff)];var _this=this;if(_this.that.sindex[index])_this.that.sindex[index].each(function(s){clearInterval(s);});this.s=setInterval(function(){_this.calcTime.call(_this,{time:timeDiff,dom:dom,el:el});},1000);this.that.sindex[index].push(this.s);if(diff>30000||(diff<=30000&&secondDiff>30)){setTimeout(function(){clearInterval(_this.s);},30000);}},addZero:function(timeDiff){for(var i=1;i<timeDiff.length;i++){if(timeDiff[i].toString().length<2){timeDiff[i]="0"+timeDiff[i].toString();return timeDiff;}}},formatToInt:function(timeDiff){for(var i=0;i<timeDiff.length;i++){parseInt(timeDiff[i]);};return timeDiff;},judgeTime:function(timeDiff,el){if(timeDiff[3]<0&&timeDiff[2]>0){timeDiff[3]=59;timeDiff[2]--;return timeDiff;}else if(timeDiff[3]<0&&timeDiff[2]==0&&timeDiff[1]>0){timeDiff[3]=59;timeDiff[2]=59;timeDiff[1]--;return timeDiff;}else if(timeDiff[3]<0&&timeDiff[2]==0&&timeDiff[1]==0&&timeDiff[0]>0){timeDiff[3]=59;timeDiff[2]=59;timeDiff[1]=23;timeDiff[0]--;return timeDiff;}else if(timeDiff[3]==0&&timeDiff[2]==0&&timeDiff[1]==0&&timeDiff[0]==0){clearInterval(this.s);if(el.callback&&typeof el.callback=='function')el.callback();return;}else if(timeDiff[3]<0){timeDiff[3]=0;return timeDiff;}},calcTime:function(obj){if(!obj.dom)return;var _timeDiff=obj.time;this.addZero(_timeDiff);this.formatToInt(_timeDiff);_timeDiff[3]--;this.judgeTime(_timeDiff,obj.el);this.addZero(_timeDiff);var dom=obj.dom;dom.second.innerHTML=_timeDiff[3];dom.minute.innerHTML=_timeDiff[2];dom.hour.innerHTML=_timeDiff[1];dom.day.innerHTML=_timeDiff[0];}};statusshow=this.statusshow={that:this,start:function(StartTime,dTime,item,index,el){var dom={day:item.getElement('.day'),second:item.getElement('.second'),minute:item.getElement('.minute'),hour:item.getElement('.hour')};try{selftimeCount.init(StartTime,dTime,dom,el,index)}catch(e){};},delay:function(EndTime,dTime,item,index,el){var dom={day:item.getElement('.day'),second:item.getElement('.second'),minute:item.getElement('.minute'),hour:item.getElement('.hour')};try{selftimeCount.init(EndTime,dTime,dom,el,index)}catch(e){};},end:function(item){item.empty();}};this.currentshow=function(el,callback){var obj=$(el).getElements('[sel=js_div]')||[],_this=this;if(!obj.length||!obj[0].getElement('.day'))return;var flag=false,random=parseInt(10000000000*Math.random()),timeNow,dTime;new Request({url:'product-getCurrentTime.html',method:'post',async:false,data:'random='+random,onSuccess:function(re){timeNow=new Date(re*1000);var NowTime=new Date();dTime=timeNow.getTime()-NowTime.getTime();obj.each(function(item,index){if(_this.sindex.length<=index)_this.sindex.push([]);var target=$(item);var EndTime=parseInt(target.get('delay'))*1000;var StartTime=parseInt(target.get('start'))*1000;if(StartTime>timeNow.getTime()){statusshow.start(StartTime,dTime,target,index,{el:el,callback:callback});target.store('action',true);flag=true;}else if(EndTime>timeNow.getTime()){statusshow.delay(EndTime,dTime,target,index,{el:el,callback:callback});target.store('action',true);flag=true;}else{if(target.retrieve('action')=='true')location.reload(true);statusshow.end(target);}});if(flag)setTimeout(function(){currentshow(el,callback)},30000);}}).send();};})();